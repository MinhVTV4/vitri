<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£n ƒë·ªì Nh√≥m Nh·∫°c H·ªôi (Realtime DB)</title>
    <!-- CSS c·ªßa Leaflet & MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <style>
        /* Reset CSS v√† style c∆° b·∫£n */
        html, body {
            height: 100%; margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
        }
        #map { width: 100%; height: 100%; background-color: #eaf0f5; }

        /* Thanh th√¥ng b√°o */
        #notification-bar {
            position: fixed; top: 0; left: 0; width: 100%;
            background-color: #5bc0de; color: white; text-align: center;
            padding: 12px; z-index: 1001; font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transform: translateY(-100%);
            transition: transform 0.3s ease-in-out;
        }
        #notification-bar.error { background-color: #d9534f; }
        #notification-bar.show { transform: translateY(0); }
        
        /* N√∫t ƒëi·ªÅu khi·ªÉn */
        .map-controls {
            position: fixed; top: 15px; right: 15px;
            z-index: 1000; display: flex; flex-direction: column; gap: 10px;
        }
        .map-controls button {
            width: 50px; height: 50px; border-radius: 50%;
            background-color: white; border: 1px solid #ddd;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15); cursor: pointer;
            font-size: 24px; line-height: 50px; text-align: center;
            transition: background-color 0.2s, transform 0.1s;
        }
        .map-controls button:hover { background-color: #f7f7f7; }
        .map-controls button:active { transform: scale(0.95); }

        /* Tooltip t√™n */
        .custom-tooltip {
            background-color: transparent; border: none; box-shadow: none;
            font-weight: bold; font-size: 12px; color: #1a1a1a;
            text-shadow: -1px -1px 0 #FFF, 1px -1px 0 #FFF, -1px 1px 0 #FFF, 1px 1px 0 #FFF;
            text-align: center;
        }

        /* Style cho marker offline */
        .marker-offline {
            opacity: 0.6 !important;
            filter: grayscale(80%);
        }

        /* --- STYLES M·ªöI CHO MARKER V√Ä CLUSTER --- */

        /* Style cho marker c·ªßa b·∫°n (hi·ªáu ·ª©ng pulse) */
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 12px rgba(0, 123, 255, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
        }
        .my-div-icon svg {
            border-radius: 50%;
            animation: pulse 2s infinite;
            overflow: visible; /* ƒê·ªÉ shadow kh√¥ng b·ªã c·∫Øt */
        }

        /* Style cho marker c·ªßa b·∫°n b√® */
        .friend-div-icon svg {
            border-radius: 50%;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.7);
        }
        
        /* Style cho gom nh√≥m (Marker Cluster) */
        .marker-cluster-small { background-color: rgba(24, 167, 105, 0.6); }
        .marker-cluster-small div { background-color: rgba(24, 167, 105, 0.9); }

        .marker-cluster-medium { background-color: rgba(240, 194, 12, 0.6); }
        .marker-cluster-medium div { background-color: rgba(241, 196, 15, 0.9); }

        .marker-cluster-large { background-color: rgba(241, 128, 23, 0.6); }
        .marker-cluster-large div { background-color: rgba(241, 128, 23, 0.9); }

        .marker-cluster {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: background-color 0.3s;
            border: 2px solid white;
        }
        .marker-cluster div {
            width: 30px;
            height: 30px;
            margin-left: 3px;
            margin-top: 3px;
            text-align: center;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            color: white;
            line-height: 30px;
        }
    </style>
</head>
<body>
    <div id="notification-bar">ƒêang k·∫øt n·ªëi...</div>
    <div id="map"></div>
    <div class="map-controls">
        <button id="zoom-to-me" title="Zoom v·ªÅ v·ªã tr√≠ c·ªßa t√¥i">üë§</button>
        <button id="zoom-to-all" title="Xem t·∫•t c·∫£ m·ªçi ng∆∞·ªùi">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</button>
    </div>

    <!-- SDK c·ªßa Leaflet & MarkerCluster -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <!-- S·ª≠ d·ª•ng script type="module" cho Firebase SDK v12+ -->
    <script type="module">
        // Import c√°c h√†m c·∫ßn thi·∫øt t·ª´ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, onDisconnect, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

        // --- PH·∫¶N 1: C·∫§U H√åNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDn-3B1ZNCq9E9XuNoHHHiyIo_Pegy8Ogk",
            authDomain: "ailocal-7501e.firebaseapp.com",
            databaseURL: "https://ailocal-7501e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ailocal-7501e",
            storageBucket: "ailocal-7501e.appspot.com",
            messagingSenderId: "21856417488",
            appId: "1:21856417488:web:c3542543f12cab547b90d5"
        };

        // --- PH·∫¶N 2: KH·ªûI T·∫†O ·ª®NG D·ª§NG ---
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const locationsRef = ref(db, 'locations');

        const notificationBar = document.getElementById('notification-bar');
        const zoomToMeBtn = document.getElementById('zoom-to-me');
        const zoomToAllBtn = document.getElementById('zoom-to-all');

        function showNotification(message, isError = false) {
            notificationBar.textContent = message;
            notificationBar.classList.toggle('error', isError);
            notificationBar.classList.add('show');
            setTimeout(() => { notificationBar.classList.remove('show'); }, 5000);
        }

        const map = L.map('map').setView([21.0285, 105.8542], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const markers = {};
        let currentUserId = null;
        let currentUserLocation = null;
        const markersLayer = L.markerClusterGroup();
        map.addLayer(markersLayer);

        // --- C√ÅC BI·ªÇU T∆Ø·ª¢NG M·ªöI ---
        const myIcon = L.divIcon({
            className: 'my-div-icon',
            html: `<svg viewBox="0 0 24 24" width="32" height="32" fill="#007bff" stroke="#fff" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>`,
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        const friendIcon = L.divIcon({
            className: 'friend-div-icon',
            html: `<svg viewBox="0 0 24 24" width="28" height="28" fill="#18a769" stroke="#fff" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>`,
            iconSize: [28, 28],
            iconAnchor: [14, 14]
        });

        // --- PH·∫¶N 3: H√ÄM TI·ªÜN √çCH & C·∫¨P NH·∫¨T MARKER ---
        function formatTimeAgo(timestamp) {
            if (!timestamp) return '';
            const now = Date.now();
            const seconds = Math.floor((now - timestamp) / 1000);

            if (seconds < 60) return `v√†i gi√¢y tr∆∞·ªõc`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} ph√∫t tr∆∞·ªõc`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} gi·ªù tr∆∞·ªõc`;
            const days = Math.floor(hours / 24);
            return `${days} ng√†y tr∆∞·ªõc`;
        }

        function updateMarker(id, userData) {
            const { name, lat, lng, status, timestamp } = userData;
            const isCurrentUser = (id === currentUserId);
            const isOffline = status === 'offline';
            
            let marker = markers[id];

            if (!marker) {
                const iconToUse = isCurrentUser ? myIcon : friendIcon; // D√πng icon t∆∞∆°ng ·ª©ng
                const markerOptions = { icon: iconToUse };
                marker = L.marker([lat, lng], markerOptions);
                markers[id] = marker;
                markersLayer.addLayer(marker);
            } else {
                marker.setLatLng([lat, lng]);
            }
            
            let tooltipContent = `<b>${name}</b>`;
            if (isOffline) {
                tooltipContent += `<br><small>L·∫ßn cu·ªëi: ${formatTimeAgo(timestamp)}</small>`;
            }
            if (marker.getTooltip()) {
                marker.setTooltipContent(tooltipContent);
            } else {
                 marker.bindTooltip(tooltipContent, {
                    permanent: true, direction: 'top', offset: [0, -15], className: 'custom-tooltip'
                });
            }

            const iconElement = marker._icon;
            if (iconElement) {
                if (isOffline) {
                    iconElement.classList.add('marker-offline');
                } else {
                    iconElement.classList.remove('marker-offline');
                }
            }
        }

        function removeMarker(id) {
            if (markers[id]) {
                markersLayer.removeLayer(markers[id]);
                delete markers[id];
            }
        }

        // --- PH·∫¶N 4: X√ÅC TH·ª∞C V√Ä L·∫ÆNG NGHE D·ªÆ LI·ªÜU ---
        signInAnonymously(auth)
            .then((userCredential) => {
                currentUserId = userCredential.user.uid;
                const userName = prompt("Nh·∫≠p t√™n c·ªßa b·∫°n:", "T√¥i") || "Ng∆∞·ªùi d√πng ·∫©n danh";
                showNotification("K·∫øt n·ªëi th√†nh c√¥ng! ƒêang l·∫•y v·ªã tr√≠ c·ªßa b·∫°n...");
                
                onValue(locationsRef, 
                    (snapshot) => {
                        const locations = snapshot.val() || {};
                        const currentlyTracked = Object.keys(markers);
                        const allUserIdsInDb = Object.keys(locations);
                        const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);

                        currentlyTracked.forEach(userId => {
                            if (!allUserIdsInDb.includes(userId)) {
                                removeMarker(userId);
                            }
                        });
                        
                        allUserIdsInDb.forEach(userId => {
                            const userData = locations[userId];
                            if (userData.status === 'offline' && userData.timestamp < oneDayAgo) {
                                remove(ref(db, 'locations/' + userId));
                                return;
                            }
                            if (userId !== currentUserId) {
                                updateMarker(userId, userData);
                            }
                        });
                    },
                    (error) => {
                        console.error("L·ªói Realtime Database:", error);
                        showNotification("L·ªói quy·ªÅn truy c·∫≠p CSDL. Vui l√≤ng ki·ªÉm tra Security Rules trong Firebase.", true);
                    }
                );

                startWatchingLocation(userName);

                const userLocationRef = ref(db, 'locations/' + currentUserId);
                onDisconnect(userLocationRef).update({ 
                    status: 'offline',
                    timestamp: serverTimestamp() 
                });

            })
            .catch((error) => {
                console.error("L·ªói x√°c th·ª±c:", error);
                showNotification("Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server. Vui l√≤ng t·∫£i l·∫°i trang.", true);
            });

        // --- PH·∫¶N 5: THEO D√ïI V·ªä TR√ç V√Ä G·ª¨I L√äN FIREBASE ---
        function startWatchingLocation(userName) {
            if (!('geolocation' in navigator)) {
                showNotification("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.", true);
                return;
            }

            let isFirstUpdate = true;
            navigator.geolocation.watchPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    currentUserLocation = [latitude, longitude];
                    
                    const locationData = {
                        name: userName,
                        lat: latitude,
                        lng: longitude,
                        timestamp: serverTimestamp(),
                        status: 'online'
                    };
                    
                    updateMarker(currentUserId, locationData);

                    if (isFirstUpdate) {
                        map.setView(currentUserLocation, 17);
                        isFirstUpdate = false;
                    }
                    
                    const userLocationRef = ref(db, 'locations/' + currentUserId);
                    await set(userLocationRef, locationData);
                },
                (error) => {
                    console.error("L·ªói v·ªã tr√≠:", error);
                    let message = "Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ c·ªßa b·∫°n. ";
                    switch(error.code) {
                        case error.PERMISSION_DENIED: message += "B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p."; break;
                        case error.POSITION_UNAVAILABLE: message += "Th√¥ng tin v·ªã tr√≠ kh√¥ng c√≥ s·∫µn."; break;
aximumAge: 0 }
            );
        }

        // --- PH·∫¶N 6: S·ª∞ KI·ªÜN C√ÅC N√öT B·∫§M ---
        zoomToMeBtn.addEventListener('click', () => {
            if (currentUserLocation) map.setView(currentUserLocation, 17);
            else showNotification("Ch∆∞a c√≥ v·ªã tr√≠ c·ªßa b·∫°n.", true);
        });

        zoomToAllBtn.addEventListener('click', () => {
            const onlineMarkers = Object.values(markers).filter(m => {
                return !m._icon.classList.contains('marker-offline');
            });

            if (onlineMarkers.length > 0) {
                const onlineGroup = L.featureGroup(onlineMarkers);
                map.fitBounds(onlineGroup.getBounds().pad(0.2));
            } else if (markersLayer.getLayers().length > 0) {
                map.fitBounds(markersLayer.getBounds().pad(0.2));
            }
            else {
                 showNotification("Ch∆∞a c√≥ ai tr√™n b·∫£n ƒë·ªì.", true);
            }
        });

    </script>
</body>
</html>

