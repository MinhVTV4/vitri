<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£n ƒë·ªì Nh√≥m Nh·∫°c H·ªôi</title>
    <!-- Nh√∫ng CSS c·ªßa Leaflet t·ª´ CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Nh√∫ng CSS cho th∆∞ vi·ªán gom nh√≥m Marker -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- CSS n·ªôi b·ªô cho ·ª©ng d·ª•ng -->
    <style>
        /* Reset CSS m·∫∑c ƒë·ªãnh v√† ƒë·∫£m b·∫£o b·∫£n ƒë·ªì to√†n m√†n h√¨nh */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Tr√°nh thanh cu·ªôn kh√¥ng c·∫ßn thi·∫øt */
        }

        #map {
            width: 100%;
            height: 100%;
            background-color: #eaf0f5;
        }

        /* Thanh th√¥ng b√°o l·ªói */
        #notification-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #d9534f;
            color: white;
            text-align: center;
            padding: 12px;
            z-index: 1001; /* ƒê·∫£m b·∫£o n√≥ hi·ªÉn th·ªã tr√™n b·∫£n ƒë·ªì */
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transform: translateY(-100%);
            transition: transform 0.3s ease-in-out;
        }
        #notification-bar.show {
            transform: translateY(0);
        }

        /* T√πy ch·ªânh popup c·ªßa Leaflet cho ƒë·∫πp h∆°n */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .leaflet-popup-content {
            margin: 13px 19px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .leaflet-popup-tip {
             background: white;
        }

        /* Container cho c√°c n√∫t ƒëi·ªÅu khi·ªÉn */
        .map-controls {
            position: fixed;
            bottom: 25px;
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Ki·ªÉu d√°ng cho c√°c n√∫t ƒëi·ªÅu khi·ªÉn */
        .map-controls button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            cursor: pointer;
            font-size: 24px;
            line-height: 50px;
            text-align: center;
            transition: background-color 0.2s, transform 0.1s;
        }

        .map-controls button:hover {
            background-color: #f7f7f7;
        }

        .map-controls button:active {
            transform: scale(0.95);
            background-color: #f0f0f0;
        }

        /* T√πy ch·ªânh tooltip ƒë·ªÉ t√™n lu√¥n hi·ªÉn th·ªã */
        .custom-tooltip {
            background-color: transparent;
            border: none;
            box-shadow: none;
            font-weight: bold;
            font-size: 12px;
            color: #1a1a1a;
            /* Th√™m vi·ªÅn ch·ªØ ƒë·ªÉ d·ªÖ ƒë·ªçc tr√™n m·ªçi n·ªÅn b·∫£n ƒë·ªì */
            text-shadow: -1px -1px 0 #FFF, 1px -1px 0 #FFF, -1px 1px 0 #FFF, 1px 1px 0 #FFF;
        }
    </style>
</head>
<body>

    <!-- Thanh th√¥ng b√°o l·ªói -->
    <div id="notification-bar"></div>

    <!-- Th·∫ª div n√†y s·∫Ω l√† n∆°i b·∫£n ƒë·ªì ƒë∆∞·ª£c hi·ªÉn th·ªã -->
    <div id="map"></div>

    <!-- C√°c n√∫t ƒëi·ªÅu khi·ªÉn b·∫£n ƒë·ªì -->
    <div class="map-controls">
        <button id="zoom-to-me" title="Zoom v·ªÅ v·ªã tr√≠ c·ªßa t√¥i">üë§</button>
        <button id="zoom-to-all" title="Xem t·∫•t c·∫£ m·ªçi ng∆∞·ªùi">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</button>
    </div>

    <!-- Nh√∫ng JavaScript c·ªßa Leaflet t·ª´ CDN -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Nh√∫ng JavaScript cho th∆∞ vi·ªán gom nh√≥m Marker -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <!-- JavaScript n·ªôi b·ªô cho ·ª©ng d·ª•ng -->
    <script>
        // --- PH·∫¶N 1: KH·ªûI T·∫†O V√Ä C·∫§U H√åNH ---

        const notificationBar = document.getElementById('notification-bar');
        const zoomToMeBtn = document.getElementById('zoom-to-me');
        const zoomToAllBtn = document.getElementById('zoom-to-all');

        function showNotification(message) {
            notificationBar.textContent = message;
            notificationBar.classList.add('show');
            setTimeout(() => {
                notificationBar.classList.remove('show');
            }, 5000);
        }

        const userName = prompt("Nh·∫≠p t√™n c·ªßa b·∫°n ƒë·ªÉ hi·ªÉn th·ªã tr√™n b·∫£n ƒë·ªì:", "T√¥i") || "Ng∆∞·ªùi d√πng ·∫©n danh";
        const map = L.map('map').setView([21.0285, 105.8542], 16);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const markers = {};
        let currentUserLocation = null;

        const markersLayer = L.markerClusterGroup();
        map.addLayer(markersLayer);

        // --- PH·∫¶N 2: X·ª¨ L√ù V·ªä TR√ç C·ª¶A B·∫†N ---

        const myIcon = L.divIcon({
            className: 'my-div-icon',
            html: `<svg viewBox="0 0 24 24" width="32" height="32" fill="#007bff" stroke="#fff" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>`,
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        function updateMarker(id, lat, lng, isCurrentUser = false) {
            const tooltipContent = `<b>${id}</b>`;
            const markerOptions = {};
            if (isCurrentUser) {
                markerOptions.icon = myIcon;
            }

            const tooltipOptions = {
                permanent: true,      // Lu√¥n hi·ªÉn th·ªã tooltip
                direction: 'top',     // Hi·ªÉn th·ªã ph√≠a tr√™n marker
                offset: [0, -15],     // Ch·ªânh v·ªã tr√≠ ƒë·ªÉ kh√¥ng che icon
                className: 'custom-tooltip' // √Åp d·ª•ng CSS t√πy ch·ªânh
            };

            if (markers[id]) {
                // N·∫øu marker ƒë√£ t·ªìn t·∫°i, ch·ªâ c·∫≠p nh·∫≠t v·ªã tr√≠
                markers[id].setLatLng([lat, lng]);
            } else {
                // N·∫øu ch∆∞a, t·∫°o marker m·ªõi v√† g·∫Øn tooltip
                const newMarker = L.marker([lat, lng], markerOptions)
                                    .bindTooltip(tooltipContent, tooltipOptions);
                
                markers[id] = newMarker; // L∆∞u l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t sau
                
                markersLayer.addLayer(newMarker); // Th√™m v√†o l·ªõp gom nh√≥m
            }
        }
        
        let isFirstLocationUpdate = true;

        if ('geolocation' in navigator) {
            navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    currentUserLocation = [latitude, longitude];

                    updateMarker(userName, latitude, longitude, true);

                    if (isFirstLocationUpdate) {
                        map.setView(currentUserLocation, 17);
                        isFirstLocationUpdate = false;
                    }
                },
                (error) => {
                    console.error("L·ªói khi l·∫•y v·ªã tr√≠:", error);
                    showNotification("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p v·ªã tr√≠.");
                }, 
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            showNotification("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.");
        }
        
        // --- PH·∫¶N 3: TH√äM S·ª∞ KI·ªÜN CHO C√ÅC N√öT ƒêI·ªÄU KHI·ªÇN ---

        zoomToMeBtn.addEventListener('click', () => {
            if (currentUserLocation) {
                map.setView(currentUserLocation, 17);
            } else {
                showNotification("Ch∆∞a c√≥ th√¥ng tin v·ªã tr√≠ c·ªßa b·∫°n.");
            }
        });

        zoomToAllBtn.addEventListener('click', () => {
            if (markersLayer.getLayers().length > 0) {
                map.fitBounds(markersLayer.getBounds().pad(0.2));
            } else {
                showNotification("Ch∆∞a c√≥ v·ªã tr√≠ c·ªßa ai tr√™n b·∫£n ƒë·ªì.");
            }
        });

        // --- PH·∫¶N 4: M√î PH·ªéNG D·ªÆ LI·ªÜU B·∫†N B√à ---
        function simulateFriends() {
            console.log("M√¥ ph·ªèng v·ªã tr√≠ b·∫°n b√®...");
            updateMarker("Anh A", 21.0288, 105.8525, false);
            updateMarker("Ch·ªã B", 21.0275, 105.8550, false);
            
            updateMarker("B·∫°n C", 21.0289, 105.8526, false);
            updateMarker("B·∫°n D", 21.0287, 105.8524, false);
        }

        setTimeout(simulateFriends, 3000);

    </script>
</body>
</html>

